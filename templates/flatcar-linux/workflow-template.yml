version: "0.1"
name: flatcar-linux
global_timeout: 1800
tasks:
  - name: flatcar-install
    worker: '{{.device_1}}'
    actions:
      - name: create-ignition
        image: flatcar-install
        command:
          - sh
          - -c
          - echo '{{.ignition}}' | base64 -d >/workflow/ignition.json
      - name: install
        image: flatcar-install
        volumes:
          - /dev:/dev
        #  - /sys/firmware/efi/efivars:/sys/firmware/efi/efivars
        command:
          # TODO mount -o remount,rw /sys/firmware/efi/efivars
          #      then we can execute efibootmgr --bootorder 0005 # 0005 in my case was the SATA disk.
          #      NB partx --show /dev/sda
          #      NB sda1 is the EFI-SYSTEM partition.
          #      NB sda2 is the BIOS-BOOT partition.
          #      NB sda3 is the USR-A partition.
          #      NB sda4 is the USR-B partition.
          #      NB sda6 is the OEM partition (ignition is stored here as config.ign)
          #      NB sda7 is the OEM-CONFIG partition.
          #      NB sda9 is the ROOT partition.
          # see https://docs.flatcar-linux.org/os/installing-to-disk/
          # see https://github.com/flatcar-linux/docs/blob/master/os/installing-to-disk.md
          # see https://github.com/flatcar-linux/init/blob/flatcar-master/bin/flatcar-install
          - /usr/local/bin/flatcar-install
          - -v
          - -d
          - '{{.boot_device}}'
          - -C
          - stable
          - -i
          - /workflow/ignition.json
      - name: reboot
        image: reboot
        volumes:
          - /worker:/worker
